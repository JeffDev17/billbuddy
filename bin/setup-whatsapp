#!/usr/bin/env ruby

puts "ğŸš€ Setting up WhatsApp Integration..."

# Check if Node.js is installed
def check_nodejs
  unless system("node --version > /dev/null 2>&1")
    puts "âŒ Node.js not found. Please install Node.js first:"
    puts "   - macOS: brew install node"
    puts "   - Ubuntu: sudo apt install nodejs npm"
    puts "   - Or download from: https://nodejs.org/"
    exit 1
  end
  
  node_version = `node --version`.strip
  puts "âœ… Node.js found: #{node_version}"
end

# Install WhatsApp API dependencies
def install_dependencies
  whatsapp_dir = File.join(__dir__, '..', 'whatsapp-api')
  
  unless File.directory?(whatsapp_dir)
    puts "âŒ WhatsApp API directory not found: #{whatsapp_dir}"
    exit 1
  end
  
  puts "ğŸ“¦ Installing WhatsApp Node.js dependencies..."
  Dir.chdir(whatsapp_dir) do
    unless system("npm install")
      puts "âŒ Failed to install dependencies"
      exit 1
    end
  end
  
  puts "âœ… Dependencies installed successfully"
end

# Add the childprocess gem if not present
def check_ruby_dependencies
  gemfile_path = File.join(__dir__, '..', 'Gemfile')
  gemfile_content = File.read(gemfile_path)
  
  unless gemfile_content.include?('childprocess')
    puts "âš ï¸  Adding childprocess gem to Gemfile..."
    File.open(gemfile_path, 'a') do |f|
      f.puts "\n# Process management for WhatsApp integration"
      f.puts "gem 'childprocess'"
    end
    
    puts "ğŸ”„ Running bundle install..."
    system("bundle install") or exit 1
  end
  
  puts "âœ… Ruby dependencies ready"
end

# Main setup process
def main
  puts "\n" + "="*50
  puts "BillBuddy WhatsApp Integration Setup"
  puts "="*50
  
  check_nodejs
  check_ruby_dependencies
  install_dependencies
  
  puts "\nâœ… WhatsApp integration setup complete!"
  puts "\nğŸ“‹ Next steps:"
  puts "   1. Start your Rails server: rails server"
  puts "   2. Visit /whatsapp/auth to authenticate"
  puts "   3. Scan the QR code with your WhatsApp"
  puts "\nğŸ‰ The WhatsApp service will start automatically with Rails!"
end

main if __FILE__ == $0 