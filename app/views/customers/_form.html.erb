<div class="bg-white dark:bg-dark-bg-secondary rounded-lg shadow p-6">
  <%= form_with(model: customer, local: true) do |form| %>
    <% if customer.errors.any? %>
      <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-800 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-4">
        <h2 class="text-lg font-medium"><%= pluralize(customer.errors.count, "erro") %> impediram que este cliente fosse salvo:</h2>
        <ul class="list-disc pl-5 mt-2">
          <% customer.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Show status history for existing customers -->
    <% if customer.persisted? && customer.status_history_display.present? %>
      <div class="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-2">üìÖ Hist√≥rico de Status</h3>
        <p class="text-sm text-blue-700 dark:text-blue-300"><%= customer.status_history_display %></p>
      </div>
    <% end %>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Basic Information -->
      <div class="space-y-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
          üë§ Informa√ß√µes B√°sicas
        </h3>

        <div>
          <%= form.label :name, "Nome", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.text_field :name, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
        </div>

        <div>
          <%= form.label :email, "Email", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.email_field :email, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
        </div>

        <div>
          <%= form.label :phone, "Telefone", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.text_field :phone, placeholder: "+5519999888777", class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Formato internacional com c√≥digo do pa√≠s</p>
        </div>

        <div>
          <%= form.label :birthdate, "Data de Nascimento", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.date_field :birthdate, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Para aparecer nos aniversariantes do m√™s</p>
        </div>
      </div>

      <!-- Status and Plan -->
      <div class="space-y-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
          ‚öôÔ∏è Status e Plano
        </h3>

        <div>
          <%= form.label :status, "Status", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.select :status, 
              options_for_select([
                ['‚úÖ Ativo', 'active'],
                ['‚ùå Inativo', 'inactive'],
                ['‚è∏Ô∏è Em espera', 'on_hold']
              ], customer.status), 
              {}, 
              { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary",
                id: "customer_status_select",
                data: { action: "change->customer-form#statusChanged" } } %>
        </div>

        <!-- Cancellation reason field (hidden by default) -->
        <div id="cancellation_reason_field" class="hidden">
          <%= form.label :cancellation_reason, "Motivo do Cancelamento", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.text_area :cancellation_reason, rows: 3,
              placeholder: "Explique o motivo da inativa√ß√£o do cliente...",
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
        </div>

        <div>
          <%= form.label :plan_type, "Tipo de Plano", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
          <%= form.select :plan_type, 
              options_for_select([
                ['üí≥ Cr√©dito', 'credit'],
                ['üìÖ Assinatura', 'subscription']
              ], customer.plan_type), 
              {}, 
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
        </div>
      </div>
    </div>

    <!-- Pricing Section -->
    <div class="mt-6">
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
        üí∞ Precifica√ß√£o Personalizada
      </h3>
      <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Configure valores personalizados para este cliente. Se deixado em branco, o sistema usar√° os valores dos pacotes de servi√ßo associados.
        </p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <%= form.label :custom_hourly_rate, "Taxa por Hora (R$)", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
            <%= form.number_field :custom_hourly_rate, step: 0.01, min: 0, 
                placeholder: "Ex: 50.00",
                class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
          </div>

          <div>
            <%= form.label :monthly_amount, "Valor Mensal (R$)", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
            <%= form.number_field :monthly_amount, step: 0.01, min: 0, 
                placeholder: "Ex: 680.00",
                class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
          </div>

          <div>
            <%= form.label :monthly_hours, "Horas Mensais", class: "block text-sm font-medium text-gray-700 dark:text-dark-text-secondary mb-1" %>
            <%= form.number_field :monthly_hours, step: 0.5, min: 0, 
                placeholder: "Ex: 8.0",
                class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-indigo-500 dark:focus:ring-dark-accent focus:border-indigo-500 dark:focus:border-dark-accent bg-white dark:bg-dark-bg-tertiary text-gray-900 dark:text-dark-text-primary" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
      <div class="flex space-x-4">
        <%= link_to "Cancelar", customer.persisted? ? customer_path(customer) : customers_path, 
            class: "px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-bg-tertiary hover:bg-gray-50 dark:hover:bg-dark-bg-primary transition-colors" %>
        
        <% if customer.persisted? %>
          <%= link_to "üìä Hist√≥rico de Pagamentos", payment_history_customer_payments_path(customer), 
              class: "px-4 py-2 border border-blue-300 dark:border-blue-700 rounded-md text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors" %>
        <% end %>
      </div>

      <div class="flex space-x-3">
        <%= form.submit customer.new_record? ? "üë§ Criar Cliente" : "‚úèÔ∏è Atualizar Cliente", 
            class: "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md dark:bg-indigo-700 dark:hover:bg-indigo-800 transition-colors" %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // Customer form controller
  document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('customer_status_select');
    const cancellationField = document.getElementById('cancellation_reason_field');
    
    function toggleCancellationField() {
      if (statusSelect.value === 'inactive') {
        cancellationField.classList.remove('hidden');
        cancellationField.querySelector('textarea').required = true;
      } else {
        cancellationField.classList.add('hidden');
        cancellationField.querySelector('textarea').required = false;
      }
    }
    
    // Initial state
    toggleCancellationField();
    
    // Listen for changes
    statusSelect.addEventListener('change', toggleCancellationField);
  });
</script>