<% content_for :title, "Revisar Sincroniza√ß√£o" %>

<div class="max-w-6xl mx-auto p-6">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
            üîç Revisar Sincroniza√ß√£o
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">
            Revise os compromissos que ser√£o sincronizados com o Google Calendar
          </p>
        </div>
        <%= link_to appointments_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" do %>
          ‚Üê Voltar para Compromissos
        <% end %>
      </div>

      <!-- Sync Summary -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
          <div class="text-2xl font-bold text-blue-700 dark:text-blue-300"><%= @sync_stats[:total_appointments] %></div>
          <div class="text-sm text-blue-600 dark:text-blue-400">Total de Compromissos</div>
        </div>
        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
          <div class="text-2xl font-bold text-green-700 dark:text-green-300"><%= @sync_stats[:total_customers] %></div>
          <div class="text-sm text-green-600 dark:text-green-400">Clientes Afetados</div>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
          <div class="text-2xl font-bold text-purple-700 dark:text-purple-300">
            <%= @sync_stats[:date_range].first&.strftime('%d/%m') || 'N/A' %>
          </div>
          <div class="text-sm text-purple-600 dark:text-purple-400">Data Inicial</div>
        </div>
        <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg">
          <div class="text-2xl font-bold text-orange-700 dark:text-orange-300">
            <%= @sync_stats[:date_range].last&.strftime('%d/%m') || 'N/A' %>
          </div>
          <div class="text-sm text-orange-600 dark:text-orange-400">Data Final</div>
        </div>
      </div>

      <!-- Scope Information -->
      <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">üìã Detalhes da Sincroniza√ß√£o</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-medium text-gray-700 dark:text-gray-300">Escopo:</span>
            <span class="text-gray-600 dark:text-gray-400">
              <% case @sync_scope %>
              <% when 'all' %>
                üîÑ Todos os compromissos n√£o sincronizados
              <% when 'upcoming' %>
                üìÖ Pr√≥ximos <%= @weeks_ahead %> semanas
              <% when 'customer' %>
                üë§ Todos os compromissos de <%= @customer.name %>
              <% when 'customer_upcoming' %>
                üë§ Pr√≥ximos <%= @weeks_ahead %> semanas de <%= @customer.name %>
              <% when 'selected_customers' %>
                üë• Pr√≥ximos <%= @weeks_ahead %> semanas de <%= @customers.count %> cliente(s) selecionado(s)
              <% when 'selected_customers_all' %>
                üë• Todos os compromissos de <%= @customers.count %> cliente(s) selecionado(s)
              <% end %>
            </span>
          </div>
          <div>
            <span class="font-medium text-gray-700 dark:text-gray-300">Status:</span>
            <span class="text-gray-600 dark:text-gray-400">N√£o sincronizados</span>
          </div>
        </div>
      </div>

      <!-- Selected Customers Info (if applicable) -->
      <% if @customers.present? %>
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg mb-6">
          <h3 class="text-lg font-medium text-blue-800 dark:text-blue-200 mb-2">üë• Clientes Selecionados</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
            <% @customers.each do |customer| %>
              <div class="bg-white dark:bg-blue-800 border border-blue-200 dark:border-blue-600 p-2 rounded text-sm">
                <span class="font-medium text-blue-900 dark:text-blue-100"><%= customer.name %></span>
                <span class="text-blue-600 dark:text-blue-300">
                  (<%= @appointments.select { |apt| apt.customer_id == customer.id }.count %> compromissos)
                </span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Appointments by Week -->
      <% if @sync_stats[:appointments_by_week].any? %>
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">üìä Compromissos por Semana</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% @sync_stats[:appointments_by_week].each do |week_start, count| %>
              <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 p-3 rounded-lg">
                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">
                  <%= week_start.strftime('%d/%m') %> - <%= (week_start + 6.days).strftime('%d/%m') %>
                </div>
                <div class="text-lg font-bold text-indigo-600 dark:text-indigo-400"><%= count %> compromissos</div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Customers Affected -->
      <% if @sync_stats[:customers_affected].any? %>
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">üë• Clientes Afetados</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
            <% @sync_stats[:customers_affected].each do |customer| %>
              <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 p-2 rounded text-sm">
                <span class="font-medium text-gray-900 dark:text-gray-100"><%= customer.name %></span>
                <span class="text-gray-500 dark:text-gray-400">
                  (<%= @appointments.select { |apt| apt.customer_id == customer.id }.count %> compromissos)
                </span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Appointments List -->
      <% if @appointments.any? %>
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">üìÖ Lista de Compromissos</h3>
          <div class="bg-white dark:bg-gray-800 shadow overflow-hidden rounded-lg">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data/Hora</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Dura√ß√£o</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <% @appointments.first(50).each do |appointment| %>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
                      <%= appointment.customer.name %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                      <%= appointment.scheduled_at.strftime('%d/%m/%Y %H:%M') %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                      <%= appointment.duration %> horas
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                        ‚è≥ N√£o Sincronizado
                      </span>
                    </td>
                  </tr>
                <% end %>
                <% if @appointments.count > 50 %>
                  <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                      ... e mais <%= @appointments.count - 50 %> compromissos
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% else %>
        <div class="text-center py-12">
          <div class="text-gray-400 dark:text-gray-500 text-6xl mb-4">üìÖ</div>
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Nenhum compromisso para sincronizar</h3>
          <p class="text-gray-600 dark:text-gray-400">Todos os compromissos no escopo selecionado j√° est√£o sincronizados.</p>
        </div>
      <% end %>

      <!-- Action Buttons -->
      <% if @appointments.any? %>
        <div class="flex justify-between items-center pt-6 border-t border-gray-200 dark:border-gray-700">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            <strong><%= @appointments.count %></strong> compromisso(s) ser√°(√£o) sincronizado(s) com o Google Calendar
          </div>
          
          <div class="flex space-x-3">
            <%= link_to "Cancelar", appointments_path, 
                class: "px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" %>
            
            <%= form_with url: confirm_sync_appointments_path, method: :post, local: true do |form| %>
              <%= form.hidden_field :scope, value: @sync_scope %>
              <%= form.hidden_field :weeks_ahead, value: @weeks_ahead %>
              <%= form.hidden_field :customer_id, value: @customer_id %>
              <% if @customer_ids.present? %>
                <% @customer_ids.each do |customer_id| %>
                  <%= form.hidden_field "customer_ids[]", value: customer_id %>
                <% end %>
              <% end %>
              
              <%= form.submit "üîÑ Confirmar Sincroniza√ß√£o", 
                  class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                  data: { confirm: "Confirma a sincroniza√ß√£o de #{@appointments.count} compromisso(s) com o Google Calendar?" } %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div> 