<div class="<%= appointment.persisted? ? '' : 'container mx-auto px-4' %>">
  <% unless appointment.persisted? %>
    <h1 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Novo Compromisso</h1>
  <% end %>

  <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
        Detalhes do Compromisso
      </h3>
    </div>
    
    <div class="px-6 py-4">
      <%= form_with model: appointment, local: true, data: { controller: "appointment-recurring cancellation-fields", turbo: false } do |form| %>
        <% if appointment.errors.any? %>
          <div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-800 rounded-md p-4 mb-6">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">
                  Encontramos alguns erros:
                </h3>
                <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                  <ul class="list-disc list-inside space-y-1">
                    <% appointment.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <%= form.label :customer_id, "Cliente", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.collection_select :customer_id, @customers, :id, :name, 
                { prompt: "Selecione um cliente" }, 
                { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" } %>
          </div>

          <div>
            <%= form.label :scheduled_at, "Data e Hora", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.datetime_local_field :scheduled_at, 
                value: appointment.scheduled_at&.strftime("%Y-%m-%dT%H:%M"),
                class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
          </div>

          <div>
            <%= form.label :duration, "DuraÃ§Ã£o (horas)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.number_field :duration, 
                step: 0.5, 
                min: 0.5, 
                value: appointment.duration || 1,
                class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
          </div>

          <!-- Manual Pricing Override -->
          <div class="col-span-2 border-t border-gray-200 dark:border-gray-600 pt-4">
            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">ðŸ’° PrecificaÃ§Ã£o</h4>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <%= form.label :hourly_rate, "Taxa por Hora (R$)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
                <%= form.number_field :hourly_rate, 
                    step: 0.01, 
                    min: 0,
                    value: appointment.hourly_rate || (appointment.customer&.effective_hourly_rate),
                    placeholder: appointment.customer&.effective_hourly_rate ? "PadrÃ£o: R$ #{sprintf('%.2f', appointment.customer.effective_hourly_rate)}" : "Ex: 85.00",
                    class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  <% if appointment.has_stored_rate? %>
                    <span class="text-blue-600 dark:text-blue-400">âœ“ Taxa personalizada definida</span>
                  <% else %>
                    Deixe em branco para usar taxa padrÃ£o do cliente
                  <% end %>
                </p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor Total</label>
                <div class="w-full px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                  <span id="total-value">
                    <% if appointment.hourly_rate.present? && appointment.duration.present? %>
                      R$ <%= sprintf('%.2f', appointment.hourly_rate * appointment.duration) %>
                    <% elsif appointment.customer&.effective_hourly_rate && appointment.duration %>
                      R$ <%= sprintf('%.2f', appointment.customer.effective_hourly_rate * appointment.duration) %>
                    <% else %>
                      R$ --,--
                    <% end %>
                  </span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Calculado automaticamente</p>
              </div>
            </div>
            
            <% if appointment.persisted? && appointment.hourly_rate.present? %>
              <div class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                <p class="text-xs text-blue-700 dark:text-blue-300">
                  <strong>Fonte:</strong> <%= appointment.rate_source&.humanize || "Personalizada" %>
                  <% if appointment.rate_source == "monthly_package" %>
                    (baseado nos valores mensais do cliente)
                  <% elsif appointment.rate_source == "custom" %>
                    (taxa personalizada do cliente)
                  <% end %>
                </p>
              </div>
            <% end %>
          </div>

          <div>
            <%= form.label :status, "Status", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.select :status, 
                options_for_select([
                  ["Agendado", "scheduled"],
                  ["ConcluÃ­do", "completed"],
                  ["Cancelado", "cancelled"],
                  ["NÃ£o compareceu", "no_show"]
                ], appointment.status), 
                {},
                { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",
                  data: { action: "change->cancellation-fields#toggleFields" } } %>
          </div>

          <!-- Campos de Cancelamento - aparecem apenas quando status Ã© 'cancelled' -->
          <div data-cancellation-fields-target="container" class="sm:col-span-2 <%= 'hidden' unless appointment.cancelled? %>">
            <div class="space-y-4 p-4 bg-red-50 dark:bg-red-900/30 rounded-md border border-red-200 dark:border-red-700">
              <h4 class="text-sm font-medium text-red-800 dark:text-red-200 mb-3">
                ðŸš« Detalhes do Cancelamento
              </h4>
              
              <div>
                <%= form.label :cancellation_type, "Tipo de Cancelamento", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                <div class="space-y-2">
                  <label class="flex items-center space-x-3 p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                    <%= form.radio_button :cancellation_type, "standard", 
                          checked: (appointment.cancellation_type == "standard"),
                          class: "text-red-600 focus:ring-red-500 border-gray-300 dark:border-gray-600" %>
                    <div class="flex-1">
                      <div class="text-sm font-medium text-gray-900 dark:text-gray-100">Cancelamento Normal</div>
                      <div class="text-sm text-gray-600 dark:text-gray-400">Cancelamento sem reagendamento nem cobranÃ§a</div>
                    </div>
                  </label>
                  
                  <label class="flex items-center space-x-3 p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                    <%= form.radio_button :cancellation_type, "pending_reschedule", 
                          checked: (appointment.cancellation_type == "pending_reschedule"),
                          class: "text-orange-600 focus:ring-orange-500 border-gray-300 dark:border-gray-600" %>
                    <div class="flex-1">
                      <div class="text-sm font-medium text-gray-900 dark:text-gray-100">Cancelar com Reagendamento</div>
                      <div class="text-sm text-gray-600 dark:text-gray-400">Cliente pode reagendar (administraÃ§Ã£o manual)</div>
                    </div>
                  </label>
                  
                  <label class="flex items-center space-x-3 p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                    <%= form.radio_button :cancellation_type, "with_revenue", 
                          checked: (appointment.cancellation_type == "with_revenue"),
                          class: "text-red-800 focus:ring-red-700 border-gray-300 dark:border-gray-600" %>
                    <div class="flex-1">
                      <div class="text-sm font-medium text-gray-900 dark:text-gray-100">Cancelamento em Cima da Hora</div>
                      <div class="text-sm text-gray-600 dark:text-gray-400">Valor serÃ¡ adicionado ao faturamento</div>
                    </div>
                  </label>
                </div>
              </div>

              <div>
                <%= form.label :cancellation_reason, "Motivo do Cancelamento", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                <%= form.text_area :cancellation_reason, 
                    rows: 3,
                    class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 dark:focus:ring-red-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",
                    placeholder: "Ex: Cliente teve compromisso urgente, problemas de saÃºde, etc." %>
              </div>

              <div>
                <%= form.label :cancelled_at, "Data do Cancelamento", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
                <%= form.datetime_local_field :cancelled_at, 
                    value: appointment.cancelled_at&.strftime("%Y-%m-%dT%H:%M"),
                    class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 dark:focus:ring-red-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
              </div>
            </div>
          </div>

          <div class="sm:col-span-2">
            <%= form.label :notes, "Notas", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.text_area :notes, 
                rows: 3,
                class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
          </div>

          <!-- Recurring Options -->
          <div class="sm:col-span-2">
            <div class="relative flex items-start">
              <div class="flex items-center h-5">
                <%= check_box_tag :is_recurring, "1", false, 
                    data: { action: "change->appointment-recurring#toggleRecurring" },
                    class: "focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded" %>
              </div>
              <div class="ml-3 text-sm">
                <%= label_tag :is_recurring, "Criar compromissos recorrentes", class: "font-medium text-gray-700 dark:text-gray-300" %>
                <p class="text-gray-500 dark:text-gray-400">Criar vÃ¡rios compromissos com base em um padrÃ£o semanal</p>
              </div>
            </div>
          </div>

          <div data-appointment-recurring-target="options" class="hidden sm:col-span-2">
            <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-md">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Repetir nos dias:
                </label>
                <div class="grid grid-cols-7 gap-2">
                  <% [
                    ["Dom", 0], ["Seg", 1], ["Ter", 2], ["Qua", 3], 
                    ["Qui", 4], ["Sex", 5], ["SÃ¡b", 6]
                  ].each do |day_name, day_value| %>
                    <label class="inline-flex items-center">
                      <%= check_box_tag "recurring_days[]", day_value, false, 
                          class: "rounded border-gray-300 dark:border-gray-600 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
                      <span class="ml-1 text-sm text-gray-700 dark:text-gray-300"><%= day_name %></span>
                    </label>
                  <% end %>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Repetir atÃ©:
                </label>
                <div class="space-y-2">
                  <label class="inline-flex items-center">
                    <%= radio_button_tag :no_end_date, "0", true, 
                        class: "form-radio text-indigo-600" %>
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Data especÃ­fica:</span>
                  </label>
                  <%= date_field_tag :recurring_until, 
                      (Date.current + 3.months).strftime("%Y-%m-%d"),
                      class: "ml-6 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
                  
                  <div>
                    <label class="inline-flex items-center">
                      <%= radio_button_tag :no_end_date, "1", false, 
                          class: "form-radio text-indigo-600" %>
                      <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">PrÃ³ximos 3 meses (padrÃ£o)</span>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-800 rounded-md p-3">
                <p class="text-sm text-blue-700 dark:text-blue-300">
                  <strong>ðŸ’¡ Dica:</strong> Para criar muitos compromissos de uma vez, considere usar a 
                  <%= link_to "CriaÃ§Ã£o em Lote", bulk_create_appointments_path, 
                      class: "text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200 underline" %>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end mt-6 space-x-3">
          <%= link_to "Cancelar", appointments_path, class: "px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" %>
          <%= form.submit "Salvar Compromisso", class: "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md dark:bg-indigo-700 dark:hover:bg-indigo-800" %>
        </div>
      <% end %>
    </div>
  </div>
</div>