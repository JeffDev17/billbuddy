<% content_for :title, "Preview: #{@target_month}" %>

<div class="max-w-6xl mx-auto p-6">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
            üîÆ Preview: <%= @target_month %>
            <span class="text-lg text-purple-600 dark:text-purple-400">(Hor√°rios Regulares)</span>
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">
            Visualiza√ß√£o dos compromissos que seriam criados baseados nos hor√°rios regulares definidos
          </p>
        </div>
        <%= link_to manage_auto_generation_appointments_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" do %>
          ‚Üê Voltar
        <% end %>
      </div>

      <!-- Summary -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-lg">
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400"><%= @preview_result[:appointments_created] %></div>
          <div class="text-sm text-blue-600 dark:text-blue-300">Compromissos a criar</div>
        </div>
        
        <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-lg">
          <div class="text-2xl font-bold text-green-600 dark:text-green-400"><%= @preview_result[:customers_processed] %></div>
          <div class="text-sm text-green-600 dark:text-green-300">Clientes com hor√°rios regulares</div>
        </div>
      </div>

      <!-- Customers with New Appointments -->
      <% if @preview_result[:appointments_created] > 0 %>
        <div class="mb-8">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            ‚úÖ Compromissos a Criar (<%= @preview_result[:appointments_created] %>)
          </h2>
          
          <div class="space-y-6">
            <% @preview_result[:details].each do |customer_detail| %>
              <% if customer_detail[:created] > 0 %>
                <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                        üë§ <%= customer_detail[:customer_name] %>
                      </h3>
                      <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium">
                        <%= customer_detail[:created] %> compromisso<%= 's' if customer_detail[:created] != 1 %>
                      </span>
                    </div>
                    
                    <!-- Individual Create Button -->
                    <%= button_to "‚úÖ Criar para #{customer_detail[:customer_name]}", generate_next_month_appointments_path,
                        method: :post,
                        params: { 
                          generation_type: 'schedule_based',
                          customer_id: customer_detail[:customer_id]
                        },
                        class: "px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-md",
                        confirm: "Criar #{customer_detail[:created]} compromissos para #{customer_detail[:customer_name]}?" %>
                  </div>
                  
                  <!-- Appointments Summary by Day -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <% 
                      # Group appointments by day of week and time
                      grouped_appointments = customer_detail[:appointments].group_by do |apt|
                        [apt[:scheduled_at].wday, apt[:scheduled_at].strftime("%H:%M"), apt[:duration]]
                      end
                    %>
                    
                    <% grouped_appointments.sort_by { |(wday, time, duration), _| [wday, time] }.each do |(wday, time, duration), appointments| %>
                      <% day_name = appointments.first[:day_name] %>
                      <% count = appointments.size %>
                      
                      <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center space-x-3">
                          <span class="text-xl">üìÖ</span>
                          <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100">
                              <%= day_name %> - <%= time %>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                              <%= duration %>h de dura√ß√£o
                            </div>
                          </div>
                        </div>
                        <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-sm font-medium">
                          <%= count %>x
                        </span>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
          
          <!-- Global Confirmation Actions -->
          <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-6 mt-6">
            <div class="text-center">
              <h3 class="text-lg font-medium text-amber-800 dark:text-amber-200 mb-2">
                Criar Todos os Compromissos
              </h3>
              <p class="text-sm text-amber-600 dark:text-amber-400 mb-4">
                <%= @preview_result[:appointments_created] %> compromissos ser√£o criados para todos os clientes acima
              </p>
              
              <div class="flex justify-center space-x-4">
                <%= link_to manage_auto_generation_appointments_path, 
                    class: "px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" do %>
                  ‚ùå Cancelar
                <% end %>
                
                <%= button_to generate_next_month_appointments_path, 
                    method: :post,
                    params: { generation_type: 'schedule_based' },
                    class: "px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md",
                    confirm: "Tem certeza que deseja criar #{@preview_result[:appointments_created]} compromissos para TODOS os clientes?" do %>
                  ‚úÖ Criar Todos os Compromissos
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Customers Already Scheduled -->
      <% 
        customers_with_existing = @preview_result[:details].select { |d| d[:created] == 0 }
        customers_with_schedules = current_user.customers.active.joins(:customer_schedules).where(customer_schedules: { enabled: true }).distinct
      %>
      
      <% if customers_with_existing.any? %>
        <div class="mb-8">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            ‚úÖ J√° Agendados
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Clientes que j√° possuem todos os compromissos criados para <%= @target_month %>
          </p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% customers_with_existing.each do |customer_detail| %>
              <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-600">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-medium text-gray-900 dark:text-gray-100">
                    üë§ <%= customer_detail[:customer_name] %>
                  </h4>
                  <span class="text-green-600 dark:text-green-400 text-sm">‚úì</span>
                </div>
                <p class="text-xs text-green-600 dark:text-green-400">
                  Todos os compromissos j√° existem
                </p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Customers Without Schedules (Always Show) -->
      <% 
        customers_without_schedules = current_user.customers.active.includes(:customer_schedules)
                                                 .select { |c| c.customer_schedules.enabled.empty? }
      %>
      
      <% if customers_without_schedules.any? %>
        <div class="mb-8">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            üìã Clientes Sem Hor√°rios Regulares
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Defina hor√°rios regulares para estes clientes para que apare√ßam nos pr√≥ximos previews
          </p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% customers_without_schedules.each do |customer| %>
              <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg border border-orange-200 dark:border-orange-600">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-medium text-gray-900 dark:text-gray-100">
                    üë§ <%= customer.name %>
                  </h4>
                </div>
                <p class="text-xs text-orange-600 dark:text-orange-400 mb-3">
                  Sem hor√°rios regulares definidos
                </p>
                <%= link_to "Definir Hor√°rios", customer_path(customer), 
                    class: "inline-block px-3 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600",
                    target: "_blank" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- No Appointments Available Message (Only when nothing to create AND no existing customers) -->
      <% if @preview_result[:appointments_created] == 0 && customers_with_existing.empty? && customers_without_schedules.empty? %>
        <div class="text-center py-12">
          <div class="text-6xl mb-4">‚úÖ</div>
          <h3 class="text-lg font-medium text-green-800 dark:text-green-200 mb-2">
            Tudo Perfeito!
          </h3>
          <p class="text-green-600 dark:text-green-300 mb-4">
            Todos os clientes t√™m hor√°rios regulares definidos e compromissos criados para <strong><%= @target_month %></strong>.
          </p>
        </div>
      <% end %>

      <% if @preview_result[:errors].any? %>
        <!-- Errors -->
        <div class="mt-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-600 rounded-lg p-4">
          <h3 class="text-lg font-medium text-red-800 dark:text-red-200 mb-2">‚ö†Ô∏è Erros Encontrados</h3>
          <ul class="text-sm text-red-600 dark:text-red-400 space-y-1">
            <% @preview_result[:errors].each do |error| %>
              <li>‚Ä¢ <%= error %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

    </div>
  </div>
</div>