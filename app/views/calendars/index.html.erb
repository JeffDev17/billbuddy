<% content_for :title, "Agenda" %>

<!-- FullCalendar CSS -->
<%= content_for :head do %>
  <style>
    .fc {
      font-family: inherit;
    }
    
    /* ========== TOOLBAR / HEADER ========== */
    .fc-toolbar {
      margin-bottom: 1rem;
      background-color: #f9fafb;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }
    
    .dark .fc-toolbar {
      background-color: #1f2937;
      border-color: #374151;
    }
    
    .fc-toolbar-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
    }
    
    .dark .fc-toolbar-title {
      color: #f9fafb;
    }
    
    .fc-button {
      background-color: #4f46e5;
      border-color: #4f46e5;
      color: white;
      border-radius: 0.375rem;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .fc-button:hover {
      background-color: #4338ca;
      border-color: #4338ca;
    }
    
    .fc-button:focus {
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }
    
    .fc-button-active {
      background-color: #3730a3 !important;
      border-color: #3730a3 !important;
    }
    
    /* ========== CALENDAR GRID ========== */
    .fc-scrollgrid {
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    
    .dark .fc-scrollgrid {
      border-color: #374151;
    }
    
    /* Day headers (days of the week) */
    .fc-col-header {
      background-color: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .dark .fc-col-header {
      background-color: #374151;
      border-bottom-color: #4b5563;
    }
    
    .fc-col-header-cell {
      padding: 0.75rem 0.5rem;
      font-weight: 600;
      color: #374151;
    }
    
    .dark .fc-col-header-cell {
      color: #d1d5db;
    }
    
    /* Calendar body */
    .fc-daygrid-body, .fc-timegrid-body {
      background-color: #ffffff;
    }
    
    .dark .fc-daygrid-body,
    .dark .fc-timegrid-body {
      background-color: #1f2937;
    }
    
    /* Day cells */
    .fc-daygrid-day {
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      background-color: #ffffff;
    }
    
    .dark .fc-daygrid-day {
      border-right-color: #374151;
      border-bottom-color: #374151;
      background-color: #1f2937;
    }
    
    .fc-daygrid-day-number {
      color: #374151;
      font-weight: 500;
      padding: 0.5rem;
    }
    
    .dark .fc-daygrid-day-number {
      color: #d1d5db;
    }
    
    /* Time grid day cells */
    .fc-timegrid-col {
      background-color: #ffffff;
    }
    
    .dark .fc-timegrid-col {
      background-color: #1f2937;
    }
    
    /* Today highlight */
    .fc-day-today {
      background-color: #eff6ff !important;
    }
    
    .dark .fc-day-today {
      background-color: #1e3a8a !important;
    }
    
    /* Fix for all calendar content background */
    .fc-daygrid-day-frame,
    .fc-daygrid-day-bg,
    .fc-daygrid-day-events {
      background-color: transparent;
    }
    
    .dark .fc-daygrid-day-frame,
    .dark .fc-daygrid-day-bg,
    .dark .fc-daygrid-day-events {
      background-color: transparent;
    }
    
    /* Basic FullCalendar styling - Dark theme is handled by fullcalendar-dark.css */
    
    /* Time slots */
    .fc-timegrid-slot {
      border-bottom: 1px solid #f3f4f6;
    }
    
    .dark .fc-timegrid-slot {
      border-bottom-color: #374151;
    }
    
    .fc-timegrid-slot-label {
      color: #6b7280;
      font-size: 0.75rem;
    }
    
    .dark .fc-timegrid-slot-label {
      color: #9ca3af;
    }
    
    /* ========== EVENTS ========== */
    .fc-daygrid-event {
      border-radius: 0.25rem;
      font-size: 0.75rem;
      padding: 0.125rem 0.25rem;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .fc-timegrid-event {
      border-radius: 0.25rem;
      font-size: 0.75rem;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .dark .fc-daygrid-event,
    .dark .fc-timegrid-event {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    .fc-event-title {
      font-weight: 500;
    }
    
    .fc-event.status-completed {
      opacity: 0.8;
    }
    
    .fc-event.status-cancelled {
      opacity: 0.7;
      text-decoration: line-through;
    }
    
    .fc-event.unsynced {
      border-left: 3px solid #f59e0b;
    }
    
    .fc-event.synced {
      border-left: 3px solid #10b981;
    }
    
    /* ========== LIST VIEW ========== */
    .fc-list-table {
      background-color: #ffffff;
    }
    
    .dark .fc-list-table {
      background-color: #1f2937;
    }
    
    .fc-list-day-cushion {
      background-color: #f9fafb;
      color: #374151;
    }
    
    .dark .fc-list-day-cushion {
      background-color: #374151;
      color: #d1d5db;
    }
    
    .fc-list-event {
      border-bottom: 1px solid #e5e7eb;
    }
    
    .dark .fc-list-event {
      border-bottom-color: #374151;
    }
    
    .fc-list-event-title {
      font-weight: 500;
      color: #111827;
    }
    
    .dark .fc-list-event-title {
      color: #f9fafb;
    }
    
    .fc-list-event-time {
      color: #6b7280;
    }
    
    .dark .fc-list-event-time {
      color: #9ca3af;
    }
    
    /* ========== LOADING ========== */
    .calendar-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 1000;
    }
    
    .dark .calendar-loading {
      background-color: rgba(31, 41, 55, 0.9);
    }
    
    /* Legend styling is handled by fullcalendar-dark.css */
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .fc-toolbar {
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
      }
      
      .fc-button-group .fc-button {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
      
      .fc-col-header-cell {
        padding: 0.5rem 0.25rem;
        font-size: 0.75rem;
      }
    }
  </style>
<% end %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
      üìÖ Agenda Interativa
    </h1>
    <div class="flex flex-wrap gap-3">
      <!-- Customer Names Toggle -->
      <div data-controller="sensitive-data" data-sensitive-data-type-value="customerNames">
        <button type="button" 
                data-action="click->sensitive-data#toggle"
                class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          <span data-sensitive-data-target="toggleIcon">üëÅÔ∏è</span>
          <span>Ocultar Nomes</span>
        </button>
      </div>
      
      <%= link_to daily_completion_calendars_path(date: Date.current), 
          class: "bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition-colors" do %>
        ‚úÖ Concluir Aulas
      <% end %>
      <%= link_to "üë• Clientes", customers_path, 
          class: "bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors" %>
      <%= link_to "üìä M√©tricas", metrics_calendars_path, 
          class: "bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors" %>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="mb-6">
    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">A√ß√µes R√°pidas</h3>
          <p class="text-xs text-blue-600 dark:text-blue-300 mt-1">
            Clique em um hor√°rio vazio para criar compromisso ‚Ä¢ Clique em um evento para editar ‚Ä¢ Arraste para mover
          </p>
        </div>
        <div class="flex flex-wrap gap-3">
          <%= link_to new_appointment_path, 
              class: "bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm transition-colors" do %>
            ‚ûï Novo Compromisso
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Calendar Sync Section (Optional) -->
  <% if current_user.google_calendar_authorized? %>
    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
              <span class="text-white text-sm">‚úì</span>
            </div>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-green-800 dark:text-green-200">
              Google Calendar Conectado
            </h3>
            <p class="text-xs text-green-600 dark:text-green-300">
              Seus compromissos podem ser sincronizados opcionalmente com o Google Calendar
            </p>
          </div>
        </div>
        <div class="flex space-x-2">
          <%= form_with url: bulk_sync_calendars_path, method: :post, local: false, class: "inline" do |form| %>
            <%= form.hidden_field :sync_all, value: "true" %>
            <%= form.submit "üîÑ Sincronizar", 
                class: "bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition-colors" %>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
              <span class="text-white text-sm">üîó</span>
            </div>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
              Sincroniza√ß√£o Opcional com Google Calendar
            </h3>
            <p class="text-xs text-yellow-600 dark:text-yellow-300">
              Conecte para espelhar seus compromissos no Google Calendar (opcional)
            </p>
          </div>
        </div>
        <div class="flex-shrink-0">
          <%= link_to redirect_calendars_path, 
              class: "bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-1 px-3 rounded text-xs transition-colors" do %>
            üîó Conectar
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Calendar Container -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 relative">
    <!-- Loading indicator -->
    <div class="calendar-loading hidden items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
        <p class="text-sm text-gray-600 dark:text-gray-400">Carregando agenda...</p>
      </div>
    </div>
    
    <!-- FullCalendar -->
    <div data-controller="fullcalendar sensitive-data" 
         data-fullcalendar-events-url-value="<%= events_calendars_path %>"
         data-fullcalendar-selected-date-value="<%= Date.current.iso8601 %>"
         data-fullcalendar-locale-value="pt-br"
         data-sensitive-data-type-value="calendar"
         data-sensitive-data-events-url-value="<%= events_calendars_path %>">
      <div data-fullcalendar-target="calendar"></div>
    </div>
  </div>

  <!-- Legend -->
  <div class="mt-6 calendar-legend rounded-lg p-4">
    <h3 class="text-sm font-medium mb-3">Legenda</h3>
    
    <!-- Status Colors -->
    <div class="mb-4">
      <h4 class="text-xs font-medium mb-2 text-gray-600 dark:text-gray-400">Status dos Compromissos</h4>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-xs">
        <div class="flex items-center">
          <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
          <span>Cr√©dito Agendado</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-purple-500 rounded mr-2"></div>
          <span>Assinatura Agendada</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-emerald-600 rounded mr-2"></div>
          <span>Conclu√≠do</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-amber-500 rounded mr-2"></div>
          <span>Falta (No Show)</span>
        </div>
      </div>
    </div>

    <!-- Cancellation Types -->
    <div class="mb-4">
      <h4 class="text-xs font-medium mb-2 text-gray-600 dark:text-gray-400">Tipos de Cancelamento</h4>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs">
        <div class="flex items-center">
          <div class="w-4 h-4 rounded mr-2" style="background-color: #ef4444;"></div>
          <span>Cancelamento Normal</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 rounded mr-2" style="background-color: #f97316;"></div>
          <span>Pendente Reagendamento</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 rounded mr-2" style="background-color: #7f1d1d;"></div>
          <span>Em Cima da Hora (Faturado)</span>
        </div>
      </div>
    </div>

    <!-- Sync Status -->
    <div>
      <h4 class="text-xs font-medium mb-2 text-gray-600 dark:text-gray-400">Status de Sincroniza√ß√£o</h4>
      <div class="grid grid-cols-2 gap-4 text-xs">
        <div class="flex items-center">
          <div class="w-2 h-4 bg-yellow-500 rounded mr-3"></div>
          <span>N√£o Sincronizado</span>
        </div>
        <div class="flex items-center">
          <div class="w-2 h-4 bg-green-500 rounded mr-3"></div>
          <span>Sincronizado</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Flash Messages Container -->
<div id="flash-messages" class="fixed top-4 right-4 z-50 space-y-2"></div>