<div class="container mx-auto px-4" 
     data-controller="payment-checklist bulk-operations" 
     data-bulk-operations-type-value="payments"
     data-bulk-operations-month-value="<%= @selected_month %>">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
      📋 Checklist de Pagamentos - <%= I18n.l(@month_date, format: "%B %Y").capitalize %>
    </h1>
    
    <div class="flex items-center space-x-4">
      <!-- Global Sensitive Data Toggle -->
      <div data-controller="sensitive-data" data-sensitive-data-type-value="global">
        <button type="button" 
                data-action="click->sensitive-data#toggle"
                class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          <span data-sensitive-data-target="toggleIcon">👁️‍🗨️</span>
          <span>Mostrar Valores</span>
        </button>
      </div>
      
      <!-- Seletor de mês -->
      <%= form_with url: monthly_checklist_payments_path, method: :get, class: "flex items-center space-x-2" do |form| %>
        <%= form.hidden_field :sort_by, value: @sort_by %>
        <%= form.month_field :month, 
            value: @selected_month, 
            class: "px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" %>
        <%= form.submit "Ver Mês", class: "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md dark:bg-indigo-700 dark:hover:bg-indigo-800" %>
      <% end %>
    </div>
  </div>

  <!-- Estatísticas do mês -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-3 mb-4">

    <!-- Estatísticas Principais -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
      <div class="text-center">
        <div class="text-xl font-bold text-green-600 dark:text-green-400" 
             data-payment-checklist-target="paidCount">
          <%= @payments_by_customer.values.flatten.count(&:paid?) %>
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Pagaram</div>
      </div>
      <div class="text-center">
        <div class="text-xl font-bold text-yellow-600 dark:text-yellow-400" 
             data-payment-checklist-target="cancelledCount">
          <%= @payments_by_customer.values.flatten.count(&:cancelled?) %>
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Cancelados</div>
      </div>
      <div class="text-center">
        <div class="text-xl font-bold text-red-600 dark:text-red-400" 
             data-payment-checklist-target="pendingCount">
          <% 
            pending_count = @customers.select { |c| 
              payment = @payments_by_customer[c.id]&.first
              payment.nil? || payment.pending?
            }.count
          %>
          <%= pending_count %>
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Pendentes</div>
      </div>
      <div class="text-center">
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400">
          <%= @customers.count %>
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Total</div>
      </div>
    </div>

    <!-- Totais Financeiros -->
    <div class="border-t border-gray-200 dark:border-gray-700 pt-2">
      <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">💰 Resumo Financeiro</h4>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-2">
        <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded-lg">
          <div class="text-center">
            <div class="text-base font-bold text-green-600 dark:text-green-400" 
                 data-payment-checklist-target="totalReceived" 
                 data-controller="sensitive-data">
              <span data-sensitive-data-target="content">R$ <%= number_with_precision(@total_received, precision: 2) %></span>
            </div>
            <div class="text-xs text-green-700 dark:text-green-300">Total Recebido</div>
          </div>
        </div>
        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-lg">
          <div class="text-center">
            <div class="text-base font-bold text-yellow-600 dark:text-yellow-400" 
                 data-payment-checklist-target="totalCancelled"
                 data-controller="sensitive-data">
              <span data-sensitive-data-target="content">R$ <%= number_with_precision(@total_cancelled, precision: 2) %></span>
            </div>
            <div class="text-xs text-yellow-700 dark:text-yellow-300">Total Cancelado</div>
          </div>
        </div>
        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg">
          <div class="text-center">
            <div class="text-base font-bold text-blue-600 dark:text-blue-400" data-controller="sensitive-data">
              <span data-sensitive-data-target="content">R$ <%= number_with_precision(@total_expected, precision: 2) %></span>
            </div>
            <div class="text-xs text-blue-700 dark:text-blue-300">Total Esperado</div>
          </div>
        </div>
        <div class="bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
          <div class="text-center">
            <div class="text-base font-bold text-red-600 dark:text-red-400" 
                 data-payment-checklist-target="totalPending"
                 data-controller="sensitive-data">
              <span data-sensitive-data-target="content">R$ <%= number_with_precision(@total_pending, precision: 2) %></span>
            </div>
            <div class="text-xs text-red-700 dark:text-red-300">Total Pendente</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerta de Inadimplentes (se houver) -->
  <% if @overdue_customers&.any? %>
    <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-6 rounded-lg">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">🚨</span>
          <div>
            <h3 class="text-base font-bold text-red-800 dark:text-red-200">
              <%= @overdue_customers.count %> Cliente<%= @overdue_customers.count > 1 ? 's' : '' %> Inadimplente<%= @overdue_customers.count > 1 ? 's' : '' %>
            </h3>
            <p class="text-xs text-red-700 dark:text-red-300">Pagamentos pendentes de meses anteriores</p>
          </div>
        </div>
        <button data-action="click->payment-checklist#filterOverdue" 
                data-payment-checklist-target="filterButton"
                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-colors">
          Filtrar
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto">
        <% @overdue_customers.each do |customer| %>
          <div class="bg-white dark:bg-gray-800 p-2 rounded border border-red-200 dark:border-red-700">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <div class="w-8 h-8 <%= customer.subscription? ? 'bg-indigo-500' : 'bg-blue-500' %> rounded-full flex items-center justify-center text-white text-xs font-medium">
                  <%= customer.name.first.upcase %>
                </div>
                <div>
                  <div class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= customer.name %></div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">
                    <% if customer.subscription? %>
                      📅 Assinatura
                    <% else %>
                      💳 Crédito
                    <% end %>
                  </div>
                </div>
              </div>
              <%= link_to customer_path(customer), class: "text-indigo-600 dark:text-indigo-400 hover:underline text-xs" do %>
                Ver Perfil →
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Layout Kanban - 3 Colunas -->
  <div class="grid grid-cols-3 gap-4">
    <% 
      pending_customers = @customers.select { |c| payment = @payments_by_customer[c.id]&.first; payment.nil? || payment.pending? }
      paid_customers = @customers.select { |c| @payments_by_customer[c.id]&.first&.paid? }
      cancelled_customers = @customers.select { |c| @payments_by_customer[c.id]&.first&.cancelled? }
    %>
    
    <!-- Coluna PENDENTE -->
    <div class="bg-yellow-50 dark:bg-yellow-900/10 rounded-lg border-2 border-yellow-300 dark:border-yellow-700">
      <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 border-b border-yellow-300 dark:border-yellow-700">
        <h3 class="text-sm font-bold text-yellow-800 dark:text-yellow-200 flex items-center justify-between">
          <span>⏳ PENDENTE</span>
          <span class="text-lg"><%= pending_customers.count %></span>
        </h3>
      </div>
      <div class="p-2 space-y-2 max-h-[600px] overflow-y-auto" data-payment-checklist-target="pendingColumn">
        <% pending_customers.each do |customer| %>
          <%= render partial: 'customer_card', locals: { customer: customer, payment: @payments_by_customer[customer.id]&.first, current_status: 'pending', selected_month: @selected_month } %>
        <% end %>
      </div>
    </div>

    <!-- Coluna PAGO -->
    <div class="bg-green-50 dark:bg-green-900/10 rounded-lg border-2 border-green-300 dark:border-green-700">
      <div class="p-3 bg-green-100 dark:bg-green-900/30 border-b border-green-300 dark:border-green-700">
        <h3 class="text-sm font-bold text-green-800 dark:text-green-200 flex items-center justify-between">
          <span>✅ PAGO</span>
          <span class="text-lg"><%= paid_customers.count %></span>
        </h3>
      </div>
      <div class="p-2 space-y-2 max-h-[600px] overflow-y-auto" data-payment-checklist-target="paidColumn">
        <% paid_customers.each do |customer| %>
          <%= render partial: 'customer_card', locals: { customer: customer, payment: @payments_by_customer[customer.id]&.first, current_status: 'paid', selected_month: @selected_month } %>
        <% end %>
      </div>
    </div>

    <!-- Coluna CANCELADO -->
    <div class="bg-gray-50 dark:bg-gray-900/10 rounded-lg border-2 border-gray-300 dark:border-gray-700">
      <div class="p-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-300 dark:border-gray-700">
        <h3 class="text-sm font-bold text-gray-800 dark:text-gray-200 flex items-center justify-between">
          <span>❌ CANCELADO</span>
          <span class="text-lg"><%= cancelled_customers.count %></span>
        </h3>
      </div>
      <div class="p-2 space-y-2 max-h-[600px] overflow-y-auto" data-payment-checklist-target="cancelledColumn">
        <% cancelled_customers.each do |customer| %>
          <%= render partial: 'customer_card', locals: { customer: customer, payment: @payments_by_customer[customer.id]&.first, current_status: 'cancelled', selected_month: @selected_month } %>
        <% end %>
      </div>
    </div>
  </div>

  <% if @customers.empty? %>
    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
      <div class="text-4xl mb-2">📝</div>
      <div class="text-lg font-medium">Nenhum cliente encontrado para este mês</div>
    </div>
  <% end %>

  <!-- Navegação entre meses -->
  <div class="mt-6 flex justify-center space-x-4">
    <%= link_to monthly_checklist_payments_path(month: (@month_date - 1.month).strftime("%Y-%m"), sort_by: @sort_by), 
        class: "px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md dark:bg-gray-600 dark:hover:bg-gray-700" do %>
      ← <%= I18n.l((@month_date - 1.month), format: "%B %Y").capitalize %>
    <% end %>
    
    <%= link_to monthly_checklist_payments_path(month: Date.current.strftime("%Y-%m"), sort_by: @sort_by), 
        class: "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md dark:bg-indigo-700 dark:hover:bg-indigo-800" do %>
      Mês Atual
    <% end %>
    
    <%= link_to monthly_checklist_payments_path(month: (@month_date + 1.month).strftime("%Y-%m"), sort_by: @sort_by), 
        class: "px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md dark:bg-gray-600 dark:hover:bg-gray-700" do %>
      <%= I18n.l((@month_date + 1.month), format: "%B %Y").capitalize %> →
    <% end %>
  </div>
  
  <div class="mt-4 text-center">
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Acesso rápido para pagamentos atrasados:</p>
    <div class="flex justify-center space-x-2 flex-wrap">
      <% (1..6).each do |months_ago| %>
        <% target_month = Date.current - months_ago.months %>
        <%= link_to monthly_checklist_payments_path(month: target_month.strftime("%Y-%m"), sort_by: @sort_by), 
            class: "#{@month_date == target_month.beginning_of_month ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'} px-2 py-1 rounded text-xs hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors duration-200 mb-1" do %>
          <%= I18n.l(target_month, format: "%b/%Y") %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<style>
.filter-button.active {
  font-weight: 600;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
}
</style>
